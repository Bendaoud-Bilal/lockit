generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./lockit.db"
}

model User {
  id                     Int           @id @default(autoincrement())
  username               String        @unique
  email                  String?       @unique
  masterPasswordHash     String        @map("master_password_hash")
  salt                   String
  kdfAlgorithm           String        @default("argon2id") @map("kdf_algorithm")
  argon2Iterations       Int           @default(3) @map("argon2_iterations")
  kdfMemory              Int           @default(65536) @map("kdf_memory")
  kdfParallelism         Int           @default(4) @map("kdf_parallelism")
  encryptedVaultKey      String        @map("encrypted_vault_key")
  vaultKeyIv             String        @map("vault_key_iv")
  vaultKeyAuthTag        String        @map("vault_key_auth_tag")
  vaultSalt              String        @map("vault_salt")
  masterKeyKdfIterations Int           @default(100000) @map("master_key_kdf_iterations")
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")
  lastLogin              DateTime?     @map("last_login")
  breachAlerts           BreachAlert[]
  credentials            Credential[]
  folders                Folder[]
  recoveryKeys           RecoveryKey[]
  sends                  Send[]

  @@map("users")
}

model RecoveryKey {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  keyHash   String    @map("key_hash")
  salt      String
  status    String    @default("active")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")
  revokedAt DateTime? @map("revoked_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("recovery_keys")
}

model Folder {
  id          Int          @id @default(autoincrement())
  userId      Int          @map("user_id")
  name        String
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  credentials Credential[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("folders")
}

model Credential {
  id                  Int           @id @default(autoincrement())
  userId              Int           @map("user_id")
  folderId            Int?          @map("folder_id")
  category            String        @default("login")
  title               String
  icon                String?
  favorite            Boolean       @default(false)
  dataEnc             String        @map("data_enc")
  dataIv              String        @map("data_iv")
  dataAuthTag         String        @map("data_auth_tag")
  hasPassword         Boolean       @default(true) @map("has_password")
  passwordStrength    Int?          @map("password_strength")
  passwordReused      Boolean       @default(false) @map("password_reused")
  passwordLastChanged DateTime?     @map("password_last_changed")
  compromised         Boolean       @default(false)
  state               String        @default("active")
  has2fa              Boolean       @default(false) @map("has_2fa")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  attachments         Attachment[]
  breachAlerts        BreachAlert[]
  folder              Folder?       @relation(fields: [folderId], references: [id])
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  totpSecrets         TotpSecret?

  @@map("credentials")
}

model TotpSecret {
  id              Int        @id @default(autoincrement())
  credentialId    Int        @unique @map("credential_id")
  serviceName     String     @map("service_name")
  accountName     String?    @unique @map("account_name")
  issuer          String?
  encryptedSecret String     @map("encrypted_secret")
  secretIv        String     @map("secret_iv")
  secretAuthTag   String     @map("secret_auth_tag")
  algorithm       String     @default("SHA1")
  digits          Int        @default(6)
  period          Int        @default(30)
  state           String     @default("active")
  createdAt       DateTime   @default(now()) @map("created_at")
  credential      Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@map("totp_secrets")
}

model Attachment {
  id            Int        @id @default(autoincrement())
  credentialId  Int        @map("credential_id")
  filename      String
  fileSize      Int        @map("file_size")
  mimeType      String?    @map("mime_type")
  encryptedData String     @map("encrypted_data")
  dataIv        String     @map("data_iv")
  dataAuthTag   String     @map("data_auth_tag")
  createdAt     DateTime   @default(now()) @map("created_at")
  credential    Credential @relation(fields: [credentialId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Send {
  id                 String    @id
  userId             Int       @map("user_id")
  name               String
  type               String
  direction          String
  encryptedContent   String    @map("encrypted_content")
  contentIv          String    @map("content_iv")
  contentAuthTag     String    @map("content_auth_tag")
  passwordProtected  Boolean   @default(false) @map("password_protected")
  maxAccessCount     Int?      @map("max_access_count")
  currentAccessCount Int       @default(0) @map("current_access_count")
  expiresAt          DateTime? @map("expires_at")
  isActive           Boolean   @default(true) @map("is_active")
  deletedAt          DateTime? @map("deleted_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sends")
}

model BreachAlert {
  id            Int         @id @default(autoincrement())
  userId        Int         @map("user_id")
  credentialId  Int?        @map("credential_id")
  affectedEmail String      @map("affected_email")
  breachSource  String      @map("breach_source")
  breachDate    DateTime?   @map("breach_date")
  affectedData  String?     @map("affected_data")
  severity      String
  status        String      @default("pending")
  createdAt     DateTime    @default(now()) @map("created_at")
  credential    Credential? @relation(fields: [credentialId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("breach_alerts")
}
